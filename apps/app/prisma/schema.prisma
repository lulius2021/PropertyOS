// PropertyOS - Prisma Schema (Phase 5: Feature Sprint Feb/Mar 2026)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE: Mandanten & Auth
// ============================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  plan      String   @default("starter")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Auto-Mahnung Konfiguration
  autoMahnungAktiv               Boolean @default(false)
  autoMahnungTageNachFaelligkeit Int     @default(7)
  autoMahnungEmailAktiv          Boolean @default(false)

  // Mahngebühren konfigurierbar (statt hardcoded)
  mahngebuehrErinnerung  Decimal @default(0) @db.Decimal(10, 2)
  mahngebuehrStufe1      Decimal @default(5) @db.Decimal(10, 2)
  mahngebuehrStufe2      Decimal @default(10) @db.Decimal(10, 2)
  mahngebuehrStufe3      Decimal @default(15) @db.Decimal(10, 2)
  verzugszinssatz        Decimal @default(5) @db.Decimal(5, 2)  // % p.a.
  mahnungGracePeriodTage Int     @default(7)

  // Zahlungsabgleich
  ausgleichsReihenfolge String @default("AELTESTE_ZUERST") // "AELTESTE_ZUERST" | "NEUESTE_ZUERST"

  users                   User[]
  objekte                 Objekt[]
  einheiten               Einheit[]
  mieter                  Mieter[]
  mietverhaeltnisse       Mietverhaeltnis[]
  dokumente               Dokument[]
  auditLogs               AuditLog[]
  einheitStatusHistorie   EinheitStatusHistorie[]
  sollstellungen          Sollstellung[]
  zahlungen               Zahlung[]
  bankImportProfiles      BankImportProfile[]
  mahnungen               Mahnung[]
  tickets                 Ticket[]
  kosten                  Kosten[]
  zeiterfassung           Zeiterfassung[]
  zaehler                 Zaehler[]
  kredite                 Kredit[]
  kpiSnapshots            KPISnapshot[]
  zahlungsguthaben        Zahlungsguthaben[]
  zustellungProtokolle    ZustellungProtokoll[]
  dienstleister           Dienstleister[]
  nebenkostenabrechnungen Nebenkostenabrechnung[]
  wartungsaufgaben        Wartungsaufgabe[]
  feedback                Feedback[]
  mieterNotizen           MieterNotiz[]

  @@map("tenants")
}

model User {
  id           String   @id @default(cuid())
  tenantId     String
  email        String
  passwordHash String
  role         UserRole @default(SACHBEARBEITER)
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Security: Account-Lockout
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?

  // Security: Passwort-Reset
  passwordResetToken   String?   @unique
  passwordResetExpires DateTime?

  // Security: 2FA/TOTP
  totpSecret    String?
  totpEnabled   Boolean  @default(false)
  recoveryCodes String?  @db.Text

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  auditLogs     AuditLog[]
  settings      UserSettings?
  feedback      Feedback[]
  mieterNotizen MieterNotiz[]

  @@unique([tenantId, email])
  @@map("users")
}

enum UserRole {
  ADMIN
  SACHBEARBEITER
  READONLY
}

model UserSettings {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  hasCompletedOnboarding Boolean  @default(false)
  themeMode              String   @default("hell")
  accentColor            String   @default("blau")
  dashboardVorlage       String   @default("vollstaendig")
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("user_settings")
}

// ============================================
// B) IMMOBILIENVERWALTUNG
// ============================================

model Objekt {
  id            String    @id @default(cuid())
  tenantId      String

  // 1) Identität & Zuordnung
  bezeichnung   String
  objektIdIntern String?
  strasse       String
  hausnummer    String?
  plz           String
  ort           String
  land          String?   @default("Deutschland")

  // Eigentümer
  eigentuemer   String?
  eigentuemeranteile String? @db.Text
  vertretungsberechtigt Boolean? @default(false)

  // 2) Objekt-Typ & Grundparameter
  objektart     Objektart?
  verwaltungsart Verwaltungsart?
  baujahr       Int?
  kernsanierungJahr Int?

  // Grundstück
  flurstueck    String?
  gemarkung     String?
  grundstueckFlaeche Decimal? @db.Decimal(10, 2)

  // Gebäude
  anzahlGebaeude Int?
  anzahlGeschosse Int?
  unterkellerung Boolean?
  aufzug        Boolean?
  tiefgarage    Boolean?

  // 3) Flächen
  wohnflaeche   Decimal?  @db.Decimal(10, 2)
  gewerbeflaeche Decimal? @db.Decimal(10, 2)
  nutzflaeche   Decimal?  @db.Decimal(10, 2)
  gesamtflaeche Decimal?  @db.Decimal(10, 2)

  // Einheiten-Anzahl
  anzahlWohnungen Int?
  anzahlGewerbe   Int?
  anzahlStellplaetze Int?

  // 4) Technische Ausstattung
  heizungsart   String?
  warmwasser    String?   // zentral/dezentral
  stromAllgemein Boolean?
  wasserUnterzaehler Boolean?
  internetVersorgung String?
  pvAnlage      Boolean?

  // 5) Vertragliche Verwaltung
  verwalterVertragBeginn DateTime?
  verwalterVertragLaufzeit String?
  verwalterVerguetung String?

  // Bankdaten
  objektkontoIban String?
  ruecklagenkontoIban String?
  hausgelkontoIban String?

  // Abrechnungssystematik
  nebenkostenUmlagefaehig Boolean?
  umlageschluessel String?

  // 6) Versorger & Dienstleister (JSON für Flexibilität)
  versorger     Json?     // Array von Versorgern
  dienstleister Json?     // Array von Dienstleistern

  // 7) Versicherungen
  versicherungen Json?    // Array von Versicherungen

  // 8) Schlüssel & Zutritt
  schliessanlage String?
  schluesselbestand String? @db.Text
  zugaenge      String?   @db.Text

  // 9) Ansprechpartner
  ansprechpartner Json?   // Array von Ansprechpartnern

  // Sonstiges
  bildUrl       String?
  notizen       String?   @db.Text
  energieausweis String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant                       Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  einheiten                    Einheit[]
  dokumente                    Dokument[]
  zaehler                      Zaehler[]
  nebenkostenabrechnungen      Nebenkostenabrechnung[]
  dienstleisterZustaendigkeiten DienstleisterObjekt[]

  @@index([tenantId])
  @@map("objekte")
}

enum Objektart {
  MFH              // Mehrfamilienhaus
  WEG              // Wohnungseigentümergemeinschaft
  SONDEREIGENTUM   // Sondereigentum
  WOHNHAUS
  GEWERBE
  GEMISCHT
  ANLAGE
}

enum Verwaltungsart {
  MIETVERWALTUNG
  WEG_VERWALTUNG
  SEV              // Sondereigentumsverwaltung
  GEMISCHT
}

model Einheit {
  id          String        @id @default(cuid())
  tenantId    String
  objektId    String
  einheitNr   String
  typ         EinheitTyp
  flaeche     Decimal       @db.Decimal(10, 2)
  zimmer      Int?
  lage        String?       // Freitext wie "1. OG links", "EG rechts", "DG Mitte"
  ausstattung String?       @db.Text
  status      EinheitStatus @default(VERFUEGBAR)
  eurProQm    Decimal?      @db.Decimal(10, 2)
  intakeToken String?       @unique  // NEU: für öffentliche Ticket-Intake-URL
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant              Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  objekt              Objekt                  @relation(fields: [objektId], references: [id], onDelete: Cascade)
  mietverhaeltnisse   Mietverhaeltnis[]
  statusHistorie      EinheitStatusHistorie[]
  dokumente           Dokument[]
  zaehler             Zaehler[] // Einheitszähler (Strom)

  @@unique([tenantId, objektId, einheitNr])
  @@index([tenantId, status])
  @@map("einheiten")
}

enum EinheitTyp {
  WOHNUNG
  GEWERBE
  STELLPLATZ
  LAGER
}

enum EinheitStatus {
  VERFUEGBAR
  VERMIETET
  KUENDIGUNG
  SANIERUNG
  RESERVIERT
}

model EinheitStatusHistorie {
  id         String        @id @default(cuid())
  tenantId   String
  einheitId  String
  status     EinheitStatus
  gueltigVon DateTime
  gueltigBis DateTime?
  notiz      String?       @db.Text
  createdBy  String?
  createdAt  DateTime      @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  einheit Einheit @relation(fields: [einheitId], references: [id], onDelete: Cascade)

  @@index([tenantId, einheitId])
  @@map("einheit_status_historie")
}

// ============================================
// C) MIETERAKTE & MIETVERHÄLTNISSE
// ============================================

model Mieter {
  id        String    @id @default(cuid())
  tenantId  String

  // 1) Personen- & Kontaktdaten
  mieterIdIntern String?
  typ       MieterTyp @default(PRIVAT)
  anrede    String?
  titel     String?
  vorname   String?
  nachname  String
  firma     String?
  geburtsdatum DateTime?
  staatsangehoerigkeit String?

  // Adresse (Meldeadresse, kann abweichen)
  strasse   String?
  hausnummer String?
  plz       String?
  ort       String?
  land      String?

  // Kontakt
  telefonMobil String?
  telefonFestnetz String?
  email     String?
  kommunikationskanal String? // E-Mail/Brief/Portal/WhatsApp

  // Notfallkontakt
  notfallkontaktName String?
  notfallkontaktBeziehung String?
  notfallkontaktTelefon String?

  // Mitmieter & Bewohner (JSON für Flexibilität)
  mitmieter Json?     // Array von Mitmieter-Objekten
  weitereBewohner Json? // Array von Bewohner-Objekten (z.B. Kinder)

  // Identität/Legitimation (DSGVO-kritisch)
  ausweisart String?
  ausweisnummer String?
  bonitaetGeprueft Boolean?
  bonitaetDatum DateTime?

  // DSGVO
  datenschutzHinweisUebergeben Boolean? @default(false)
  datenschutzDatum DateTime?
  einwilligungen Json? // Array von Einwilligungen

  // Sonstiges
  telefon   String?  // Legacy-Feld, wird durch telefonMobil ersetzt
  notizen   String?  @db.Text

  // NEU: IBAN für automatisches Matching
  iban      String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  mietverhaeltnisse Mietverhaeltnis[]
  dokumente         Dokument[]
  mieterNotizen     MieterNotiz[]

  @@index([tenantId])
  @@map("mieter")
}

enum MieterTyp {
  PRIVAT
  GEWERBE
  GESCHAEFTLICH
}

model Mietverhaeltnis {
  id              String        @id @default(cuid())
  tenantId        String
  mieterId        String
  einheitId       String

  // 3) Mietvertrag
  vertragsnummer  String?
  vertragsart     Vertragsart?  @default(UNBEFRISTET)
  einzugsdatum    DateTime
  uebergabedatum  DateTime?
  auszugsdatum    DateTime?
  befristungsgrund String?
  kuendigungsfrist String?

  // Miete
  kaltmiete       Decimal       @db.Decimal(10, 2)
  bkVorauszahlung Decimal       @db.Decimal(10, 2)
  hkVorauszahlung Decimal       @db.Decimal(10, 2)
  stellplatzmiete Decimal?      @db.Decimal(10, 2)
  moeblierungszuschlag Decimal? @db.Decimal(10, 2)
  sonstigePauschalen Decimal?   @db.Decimal(10, 2)

  // Staffel-/Indexmiete
  staffelmiete    Json?         // Array von Stufen
  indexmiete      Json?         // Index-Details

  // Kaution
  kaution         Decimal?      @db.Decimal(10, 2)
  kautionStatus   KautionStatus @default(AUSSTEHEND)
  kautionsart     String?       // Bar/Konto/Bürgschaft/Versicherung
  kautionEingaenge Json?        // Array von Zahlungen
  kautionRueckzahlung Json?     // Rückzahlungs-Details

  // Sondervereinbarungen
  hausordnungAnerkannt Boolean?
  tierhaltungGeregelt Boolean?
  tierhaltungDetails String?
  rauchenErlaubt Boolean?
  schoenheitsreparaturen String?
  schluesselanzahl Int?

  // Zahlungsdetails
  zahlweise       String?       // Überweisung/SEPA/Dauerauftrag
  faelligkeit     String?       // z.B. "3. Werktag"
  verwendungszweck String?

  // Nebenkosten-Abrechnung
  umlageschluessel String?
  personenanzahl  Int?
  personenHistorie Json?        // Array von {datum, anzahl}

  // Übergabe/Zustand
  uebergabeprotokoll Json?      // Einzugs-/Auszugsdetails
  zustandsbewertung Json?
  maengelliste    Json?
  zaehlerstaendeEinzug Json?
  zaehlerstaendeAuszug Json?

  // Kommunikation
  nachsendeadresse String?

  vertragStatus   VertragStatus @default(ENTWURF)
  notizen         String?       @db.Text

  // NEU: Sperrlogik für Mahnwesen
  mahnungGesperrt    Boolean   @default(false)
  mahnungSperrGrund  String?
  mahnungGesperrtBis DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  tenant          Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  mieter          Mieter          @relation(fields: [mieterId], references: [id], onDelete: Cascade)
  einheit         Einheit         @relation(fields: [einheitId], references: [id], onDelete: Cascade)
  dokumente       Dokument[]
  sollstellungen  Sollstellung[]
  zaehlerstaende  Zaehlerstand[]
  mahnungen       Mahnung[]
  nkaMieterpositionen NKAMieterposition[]

  @@index([tenantId, einheitId])
  @@index([tenantId, mieterId])
  @@map("mietverhaeltnisse")
}

enum Vertragsart {
  UNBEFRISTET
  BEFRISTET
  UNTERMIETE
  STAFFELMIETE
  INDEXMIETE
  GEWERBE
}

enum KautionStatus {
  AUSSTEHEND
  TEILZAHLUNG
  VOLLSTAENDIG
  HINTERLEGT_BANK
  ZURUECKGEZAHLT
}

enum VertragStatus {
  ENTWURF
  GENERIERT
  VERSANDT
  UNTERSCHRIEBEN
  AKTIV
  BEENDET
}

// ============================================
// D) DOKUMENTE
// ============================================

model Dokument {
  id                String      @id @default(cuid())
  tenantId          String
  typ               DokumentTyp
  dateiname         String
  s3Key             String // CloudFlare R2 / S3 Key
  mimeType          String
  groesse           Int // Bytes
  hochgeladenAm     DateTime    @default(now())
  // Polymorphic Associations
  dateiinhalt       String?     @db.Text // base64 für MVP
  objektId          String?
  einheitId         String?
  mieterId          String?
  mietverhaeltnisId String?
  mahnungId         String?
  ticketId          String?
  kostenId          String?
  kreditId          String?
  wartungsaufgabeId String?
  notiz             String?     @db.Text

  // NEU: Versionierung
  version           Int       @default(1)
  faelligkeitsdatum DateTime? // abgeleitete Frist
  fristTyp          String?   // KUENDIGUNG, WARTUNG, PRUEFUNG, etc.
  vorgaengerId      String?
  schlagworte       String?   // Komma-getrennt

  vorgaenger        Dokument?  @relation("Versionskette", fields: [vorgaengerId], references: [id])
  nachfolger        Dokument[] @relation("Versionskette")

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  objekt          Objekt?          @relation(fields: [objektId], references: [id], onDelete: Cascade)
  einheit         Einheit?         @relation(fields: [einheitId], references: [id], onDelete: Cascade)
  mieter          Mieter?          @relation(fields: [mieterId], references: [id], onDelete: Cascade)
  mietverhaeltnis Mietverhaeltnis? @relation(fields: [mietverhaeltnisId], references: [id], onDelete: Cascade)
  mahnung         Mahnung?         @relation(fields: [mahnungId], references: [id], onDelete: Cascade)
  ticket          Ticket?          @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  kosten          Kosten?          @relation(fields: [kostenId], references: [id], onDelete: Cascade)
  kredit          Kredit?          @relation(fields: [kreditId], references: [id], onDelete: Cascade)
  wartungsaufgabe Wartungsaufgabe? @relation(fields: [wartungsaufgabeId], references: [id])

  @@index([tenantId, typ])
  @@map("dokumente")
}

enum DokumentTyp {
  MIETVERTRAG
  MAHNUNG
  RECHNUNG
  ZAEHLERABLESUNG
  DARLEHEN
  SONSTIGES
}

// ============================================
// AUDIT-LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  aktion     String // z.B. "OBJEKT_ERSTELLT", "EINHEIT_GEAENDERT"
  entitaet   String // z.B. "Objekt", "Einheit"
  entitaetId String
  altWert    String?  @db.Text
  neuWert    String?  @db.Text
  timestamp  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])

  @@index([tenantId, entitaet, entitaetId])
  @@index([tenantId, timestamp])
  @@map("audit_logs")
}

// ============================================
// E) SOLLSTELLUNGEN & OFFENE POSTEN
// ============================================

model Sollstellung {
  id                     String              @id @default(cuid())
  tenantId               String
  mietverhaeltnisId      String?
  typ                    SollstellungTyp
  titel                  String
  betragGesamt           Decimal             @db.Decimal(10, 2)
  // Warmmiete-Komponenten (nur wenn typ = WARMMIETE)
  kaltmiete              Decimal?            @db.Decimal(10, 2)
  bkVorauszahlung        Decimal?            @db.Decimal(10, 2)
  hkVorauszahlung        Decimal?            @db.Decimal(10, 2)
  faelligkeitsdatum      DateTime
  status                 SollstellungStatus  @default(OFFEN)
  // Gedeckte Beträge
  gedecktGesamt          Decimal             @default(0) @db.Decimal(10, 2)
  gedecktKalt            Decimal?            @default(0) @db.Decimal(10, 2)
  gedecktBK              Decimal?            @default(0) @db.Decimal(10, 2)
  gedecktHK              Decimal?            @default(0) @db.Decimal(10, 2)
  notiz                  String?             @db.Text
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  // Mahnkosten/Verzugszinsen referenzieren ursprüngliche Sollstellung
  ursprungSollstellungId String?
  ursprungSollstellung   Sollstellung?       @relation("MahnkostenOrigin", fields: [ursprungSollstellungId], references: [id])
  mahnkosten             Sollstellung[]      @relation("MahnkostenOrigin")

  tenant             Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  mietverhaeltnis    Mietverhaeltnis?     @relation(fields: [mietverhaeltnisId], references: [id], onDelete: Cascade)
  zahlungZuordnungen ZahlungZuordnung[]

  @@index([tenantId, status])
  @@index([tenantId, mietverhaeltnisId])
  @@map("sollstellungen")
}

enum SollstellungTyp {
  WARMMIETE
  KAUTION
  NEBENKOSTEN
  MAHNGEBUEHR
  VERZUGSZINSEN
  SONSTIGE
}

enum SollstellungStatus {
  OFFEN
  TEILWEISE_BEZAHLT
  BEZAHLT
  STORNIERT
}

// ============================================
// F) BANKIMPORT & ZAHLUNGEN
// ============================================

model BankImportProfile {
  id                     String   @id @default(cuid())
  tenantId               String
  profilName             String
  csvSeparator           String   @default(";")
  datumSpalte            Int
  betragSpalte           Int
  verwendungszweckSpalte Int
  ibanSpalte             Int?
  createdAt              DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, profilName])
  @@map("bank_import_profiles")
}

model Zahlung {
  id               String             @id @default(cuid())
  tenantId         String
  datum            DateTime
  betrag           Decimal            @db.Decimal(10, 2)
  verwendungszweck String             @db.Text
  iban             String?
  status           ZahlungStatus      @default(UNKLAR)
  importiertAm     DateTime           @default(now())
  zugeordnetAm     DateTime?

  tenant      Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  zuordnungen ZahlungZuordnung[]
  guthaben    Zahlungsguthaben[]

  @@index([tenantId, status])
  @@map("zahlungen")
}

enum ZahlungStatus {
  UNKLAR
  ZUGEORDNET
  TEILWEISE_ZUGEORDNET
  IGNORIERT
  SPLITTET
  RUECKLASTSCHRIFT // NEU
}

model ZahlungZuordnung {
  id             String       @id @default(cuid())
  tenantId       String
  zahlungId      String
  sollstellungId String
  betrag         Decimal      @db.Decimal(10, 2)
  // Deckung pro Komponente (für Warmmiete)
  deckungKalt    Decimal?     @db.Decimal(10, 2)
  deckungBK      Decimal?     @db.Decimal(10, 2)
  deckungHK      Decimal?     @db.Decimal(10, 2)
  zugeordnetAm   DateTime     @default(now())
  zugeordnetVon  String? // User ID

  zahlung      Zahlung      @relation(fields: [zahlungId], references: [id], onDelete: Cascade)
  sollstellung Sollstellung @relation(fields: [sollstellungId], references: [id], onDelete: Cascade)

  @@index([tenantId, zahlungId])
  @@index([tenantId, sollstellungId])
  @@map("zahlung_zuordnungen")
}

// NEU: Überzahlungs-Gutschriften
model Zahlungsguthaben {
  id                String   @id @default(cuid())
  tenantId          String
  mietverhaeltnisId String
  betrag            Decimal  @db.Decimal(10, 2)
  entstanden        DateTime @default(now())
  verbraucht        Boolean  @default(false)
  zahlungId         String
  createdAt         DateTime @default(now())

  tenant    Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  zahlung   Zahlung @relation(fields: [zahlungId], references: [id], onDelete: Cascade)

  @@index([tenantId, mietverhaeltnisId])
  @@map("zahlungsguthaben")
}

// ============================================
// G) MAHNWESEN
// ============================================

model Mahnung {
  id                     String      @id @default(cuid())
  tenantId               String
  mietverhaeltnisId      String
  mahnstufe              Mahnstufe
  mahnDatum              DateTime
  offenerBetrag          Decimal     @db.Decimal(10, 2)
  mahngebuehr            Decimal     @default(0) @db.Decimal(10, 2)
  verzugszinsen          Decimal     @default(0) @db.Decimal(10, 2)
  // Referenzen zu generierten Sollstellungen
  mahngebuehrPostenId    String?
  verzugszinsenPostenId  String?
  status                 MahnStatus  @default(OFFEN)
  dokumentGeneriert      Boolean     @default(false)
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt

  tenant              Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  mietverhaeltnis     Mietverhaeltnis       @relation(fields: [mietverhaeltnisId], references: [id], onDelete: Cascade)
  dokumente           Dokument[]
  zustellungProtokolle ZustellungProtokoll[]

  @@index([tenantId, status])
  @@index([tenantId, mietverhaeltnisId])
  @@map("mahnungen")
}

enum Mahnstufe {
  ERINNERUNG
  MAHNUNG_1
  MAHNUNG_2
  MAHNUNG_3
}

enum MahnStatus {
  OFFEN
  VERSENDET
  BEZAHLT
  STORNIERT
  STRITTIG  // NEU
  INKASSO   // NEU
}

// NEU: Zustellprotokoll
model ZustellungProtokoll {
  id        String   @id @default(cuid())
  tenantId  String
  mahnungId String
  methode   String   // BRIEF, EMAIL, EINSCHREIBEN, PERSOENLICH
  datum     DateTime @default(now())
  bearbeiter String?
  status    String   @default("VERSENDET") // VERSENDET, ZUGESTELLT, GESCHEITERT
  notiz     String?  @db.Text
  createdAt DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  mahnung Mahnung @relation(fields: [mahnungId], references: [id], onDelete: Cascade)

  @@index([tenantId, mahnungId])
  @@map("zustellung_protokoll")
}

// ============================================
// H) TICKETSYSTEM
// ============================================

model Ticket {
  id                String           @id @default(cuid())
  tenantId          String
  titel             String
  beschreibung      String           @db.Text
  kategorie         TicketKategorie
  prioritaet        TicketPrioritaet @default(MITTEL)
  status            TicketStatus     @default(ERFASST)
  // Zuordnungen (optional)
  objektId          String?
  einheitId         String?
  verantwortlicher  String? // User ID
  frist             DateTime?
  ersteller         String? // User ID
  herkunft          String?          // INTERN, MIETER_PORTAL

  // NEU: SLA, Dienstleister, Kostenlimit
  slaFaelligkeitDatum  DateTime?
  dienstleisterId      String?
  kostenlimitFreigabe  Decimal?  @db.Decimal(10, 2)
  kostenartUmlagefaehig Boolean  @default(false)

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  tenant          Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dienstleister   Dienstleister?      @relation(fields: [dienstleisterId], references: [id])
  kommentare      TicketKommentar[]
  dokumente       Dokument[]
  statusHistorie  TicketStatusHistorie[]

  @@index([tenantId, status])
  @@map("tickets")
}

enum TicketKategorie {
  SCHADENSMELDUNG
  WARTUNG
  ANFRAGE
  BESCHWERDE
  SANIERUNG
  AUFGABE
}

enum TicketPrioritaet {
  NIEDRIG
  MITTEL
  HOCH
  KRITISCH
}

enum TicketStatus {
  ERFASST
  IN_BEARBEITUNG
  ZUR_PRUEFUNG
  ABGESCHLOSSEN
  BEAUFTRAGT        // NEU: Handwerker beauftragt
  TERMIN_VEREINBART // NEU
  IN_ARBEIT         // NEU: Handwerker vor Ort
  RUECKFRAGE        // NEU: Rückfrage an Mieter/Eigentümer
  ABGERECHNET       // NEU: Rechnung erhalten und bezahlt
}

model TicketKommentar {
  id              String    @id @default(cuid())
  tenantId        String
  ticketId        String
  text            String    @db.Text
  verfasser       String?   // User ID
  ereigniszeit    DateTime? // Wann ist es passiert (manuell wählbar)
  dienstleisterId String?   // Optionale Referenz zu Dienstleister
  createdAt       DateTime  @default(now())

  ticket        Ticket         @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  dienstleister Dienstleister? @relation("KommentarDienstleister", fields: [dienstleisterId], references: [id])

  @@index([tenantId, ticketId])
  @@map("ticket_kommentare")
}

// NEU: Dienstleister-Stammdaten
model Dienstleister {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  telefon   String?
  email     String?
  kategorie String?  // ELEKTRIKER, SANITAER, HEIZUNG, AUFZUG, etc.
  notiz     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tickets           Ticket[]
  ticketKommentare  TicketKommentar[]     @relation("KommentarDienstleister")
  objektZustaendigkeiten DienstleisterObjekt[]

  @@index([tenantId])
  @@map("dienstleister")
}

// NEU: Ticket Status-Historie
model TicketStatusHistorie {
  id         String       @id @default(cuid())
  ticketId   String
  vonStatus  TicketStatus
  zuStatus   TicketStatus
  datum      DateTime     @default(now())
  bearbeiter String?
  notiz      String?

  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@map("ticket_status_historie")
}

// ============================================
// I) KOSTEN & ZEIT
// ============================================

model Kosten {
  id                String          @id @default(cuid())
  tenantId          String
  datum             DateTime
  betragBrutto      Decimal         @db.Decimal(10, 2)
  lieferant         String
  kategorie         String
  beschreibung      String?         @db.Text
  bkRelevant        Boolean         @default(false)
  hkRelevant        Boolean         @default(false)
  jahr              Int             // Extrahiert aus datum für Abrechnung

  // Offene Posten Erweiterung
  rechnungsdatum    DateTime?       // Rechnungsdatum
  faelligkeitsdatum DateTime?       // Fälligkeitsdatum
  rechnungsnummer   String?         // Rechnungsnummer
  lieferantenRef    String?         // Lieferantenreferenz

  // Zuordnungen (optional)
  objektId          String?
  einheitId         String?
  ticketId          String?
  createdAt         DateTime        @default(now())

  tenant            Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dokumente         Dokument[]
  zahlungen         KostenZahlung[] // Zahlungen für diese Kostenposition

  @@index([tenantId, jahr])
  @@index([tenantId, bkRelevant])
  @@index([tenantId, hkRelevant])
  @@index([tenantId, faelligkeitsdatum])
  @@map("kosten")
}

model KostenZahlung {
  id        String   @id @default(cuid())
  tenantId  String
  kostenId  String
  datum     DateTime
  betrag    Decimal  @db.Decimal(10, 2)
  notiz     String?  @db.Text
  createdAt DateTime @default(now())

  kosten Kosten @relation(fields: [kostenId], references: [id], onDelete: Cascade)

  @@index([tenantId, kostenId])
  @@map("kosten_zahlungen")
}

model Zeiterfassung {
  id             String    @id @default(cuid())
  tenantId       String
  datum          DateTime
  start          DateTime?
  ende           DateTime?
  dauer          Decimal?  @db.Decimal(5, 2) // Stunden
  taetigkeit     String
  rolleFunktion  String?
  // Zuordnungen (optional)
  objektId       String?
  einheitId      String?
  ticketId       String?
  erfasstVon     String? // User ID
  createdAt      DateTime  @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, datum])
  @@map("zeiterfassung")
}

// ============================================
// J) ZÄHLERVERWALTUNG
// ============================================

model Zaehler {
  id            String         @id @default(cuid())
  tenantId      String
  zaehlernummer String
  typ           ZaehlerTyp
  // Zuordnung ENTWEDER Objekt ODER Einheit
  objektId      String?
  einheitId     String?
  createdAt     DateTime       @default(now())

  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  objekt     Objekt?        @relation(fields: [objektId], references: [id], onDelete: Cascade)
  einheit    Einheit?       @relation(fields: [einheitId], references: [id], onDelete: Cascade)
  ablesungen Zaehlerstand[]

  @@unique([tenantId, zaehlernummer])
  @@index([tenantId, objektId])
  @@index([tenantId, einheitId])
  @@map("zaehler")
}

enum ZaehlerTyp {
  STROM
  GAS
  WASSER_KALT
  WASSER_WARM
  WAERME
}

model Zaehlerstand {
  id                String           @id @default(cuid())
  tenantId          String
  zaehlerId         String
  datum             DateTime
  stand             Decimal          @db.Decimal(10, 2)
  ablesesTyp        AblesesTyp       @default(REGULAER)
  mietverhaeltnisId String? // Bei Ein-/Auszug
  notiz             String?          @db.Text
  fotoS3Key         String?
  erfasstVon        String? // User ID
  createdAt         DateTime         @default(now())

  zaehler         Zaehler          @relation(fields: [zaehlerId], references: [id], onDelete: Cascade)
  mietverhaeltnis Mietverhaeltnis? @relation(fields: [mietverhaeltnisId], references: [id])

  @@index([tenantId, zaehlerId])
  @@map("zaehlerstaende")
}

enum AblesesTyp {
  REGULAER
  EINZUG
  AUSZUG
}

// ============================================
// K) KREDITVERWALTUNG
// ============================================

model Kredit {
  id                 String             @id @default(cuid())
  tenantId           String
  bezeichnung        String             // Beschreibender Name
  bank               String             // Gläubiger/Bank
  referenznummer     String?            // Vertragsnummer
  startdatum         DateTime
  auszahlungsdatum   DateTime?          // Tatsächliches Auszahlungsdatum
  ursprungsbetrag    Decimal            @db.Decimal(12, 2) // Darlehenssumme
  zinssatz           Decimal            @db.Decimal(5, 4)  // z.B. 0.0325 = 3.25% p.a.
  rate               Decimal            @db.Decimal(10, 2) // Monatliche Annuität
  laufzeitMonate     Int
  zinsbindungBis     DateTime?
  laufzeitEnde       DateTime?          // Geplantes Laufzeitende
  zahlungsfrequenz   String             @default("MONATLICH") // Nur monatlich in V1

  // Zuordnungen
  objektId           String?
  einheitId          String?

  notizen            String?            @db.Text
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sondertilgungen    Sondertilgung[]
  dokumente          Dokument[]

  @@index([tenantId])
  @@index([objektId])
  @@map("kredite")
}

// ============================================
// KPI SNAPSHOTS (Dashboard-Verlauf)
// ============================================

model KPISnapshot {
  id        String   @id @default(cuid())
  tenantId  String
  widgetTyp String   // z.B. "rueckstaende", "tickets", "vermietungsquote"
  wertText  String   // Angezeigter Wert, z.B. "€5.320,00" oder "93 %"
  wertZahl  Float?   // Numerischer Wert für Vergleich & Trend
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, widgetTyp, createdAt])
  @@map("kpi_snapshots")
}

model Sondertilgung {
  id         String   @id @default(cuid())
  tenantId   String
  kreditId   String
  datum      DateTime
  betrag     Decimal  @db.Decimal(12, 2)
  notiz      String?  @db.Text
  createdAt  DateTime @default(now())

  kredit     Kredit   @relation(fields: [kreditId], references: [id], onDelete: Cascade)

  @@index([tenantId, kreditId])
  @@map("sondertilgungen")
}

// ============================================
// L) NEBENKOSTENABRECHNUNG (NEU)
// ============================================

model Nebenkostenabrechnung {
  id              String    @id @default(cuid())
  tenantId        String
  objektId        String
  abrechnungsjahr Int
  vonDatum        DateTime
  bisDatum        DateTime
  status          NKAStatus @default(ENTWURF)
  gesamtkosten    Decimal?  @db.Decimal(12, 2)
  notiz           String?   @db.Text
  erstelltAm      DateTime  @default(now())
  freigegebenAm   DateTime?
  updatedAt       DateTime  @updatedAt

  tenant          Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  objekt          Objekt             @relation(fields: [objektId], references: [id], onDelete: Cascade)
  positionen      NKAPosition[]
  mieterpositionen NKAMieterposition[]

  @@index([tenantId, abrechnungsjahr])
  @@index([tenantId, objektId])
  @@map("nebenkostenabrechnungen")
}

enum NKAStatus {
  ENTWURF
  BERECHNET
  FREIGEGEBEN
  VERSENDET
  ABGESCHLOSSEN
}

model NKAPosition {
  id                   String               @id @default(cuid())
  nkaId                String
  kostenartBezeichnung String
  betragGesamt         Decimal              @db.Decimal(12, 2)
  umlageschluessel     UmlageschluesselTyp
  bkRelevant           Boolean              @default(true)
  hkRelevant           Boolean              @default(false)
  betragProEinheit     Json?                // { einheitId: betrag }
  createdAt            DateTime             @default(now())

  nka Nebenkostenabrechnung @relation(fields: [nkaId], references: [id], onDelete: Cascade)

  @@index([nkaId])
  @@map("nka_positionen")
}

model NKAMieterposition {
  id                  String  @id @default(cuid())
  nkaId               String
  mietverhaeltnisId   String
  einheitId           String
  vorauszahlungGesamt Decimal @db.Decimal(12, 2)
  istKostenGesamt     Decimal @db.Decimal(12, 2)
  differenz           Decimal @db.Decimal(12, 2) // positiv = Nachforderung, negativ = Guthaben
  anteilsTage         Int     @default(365)
  createdAt           DateTime @default(now())

  nka             Nebenkostenabrechnung @relation(fields: [nkaId], references: [id], onDelete: Cascade)
  mietverhaeltnis Mietverhaeltnis       @relation(fields: [mietverhaeltnisId], references: [id], onDelete: Cascade)

  @@index([nkaId])
  @@index([mietverhaeltnisId])
  @@map("nka_mieterpositionen")
}

enum UmlageschluesselTyp {
  FLAECHE
  PERSONEN
  EINHEITEN
  VERBRAUCH
  TAGE
  PAUSCHAL
}

// ============================================
// M) WARTUNGSPLAN (NEU)
// ============================================

model Wartungsaufgabe {
  id                  String    @id @default(cuid())
  tenantId            String
  objektId            String?
  einheitId           String?
  bezeichnung         String    // "Heizungswartung", "Aufzug TÜV"
  kategorie           String    // HEIZUNG, AUFZUG, BRANDSCHUTZ, RAUCHWARNMELDER, etc.
  intervallMonate     Int       // 12 = jährlich, 24 = alle 2 Jahre
  letzteAusfuehrung   DateTime?
  naechsteFaelligkeit DateTime
  verantwortlicher    String?
  notiz               String?   @db.Text
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dokumente Dokument[]

  @@index([tenantId, naechsteFaelligkeit])
  @@map("wartungsaufgaben")
}

// ============================================
// O) MIETER NOTIZEN
// ============================================
model MieterNotiz {
  id        String   @id @default(cuid())
  tenantId  String
  mieterId  String
  userId    String
  inhalt    String   @db.Text
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  mieter Mieter @relation(fields: [mieterId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([mieterId, createdAt])
  @@map("mieter_notizen")
}

// ============================================
// P) DIENSTLEISTER-OBJEKTE (Zuständigkeit)
// ============================================
model DienstleisterObjekt {
  dienstleisterId String
  objektId        String
  createdAt       DateTime @default(now())

  dienstleister Dienstleister @relation(fields: [dienstleisterId], references: [id], onDelete: Cascade)
  objekt        Objekt        @relation(fields: [objektId], references: [id], onDelete: Cascade)

  @@id([dienstleisterId, objektId])
  @@map("dienstleister_objekte")
}

// ============================================
// N) FEEDBACK
// ============================================
model Feedback {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  bewertung Int?     // 1–5 Sterne (optional)
  kategorie String   @default("ALLGEMEIN") // ALLGEMEIN | FEATURE | BUG | LOB
  nachricht String   @db.Text
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@map("feedback")
}
